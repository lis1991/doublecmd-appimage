# AppImageBuilder.yml
version: 1

script:
  - rm -rf AppDir || true
  - mkdir -p AppDir/usr/bin AppDir/usr/share/applications AppDir/usr/share/icons/hicolor/256x256/apps

  - |
    echo "–ü–æ–∏—Å–∫ –ø–æ—Å–ª–µ–¥–Ω–µ–π –≤–µ—Ä—Å–∏–∏ Double Commander —á–µ—Ä–µ–∑ RSS..."
    # –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ: –£–±—Ä–∞–Ω—ã –ª–∏—à–Ω–∏–µ –ø—Ä–æ–±–µ–ª—ã –≤ URL –≤–Ω—É—Ç—Ä–∏ grep
    LATEST_URL=$(curl -s "https://sourceforge.net/projects/doublecmd/rss?path=/" | \
    grep -o '<link>https://sourceforge.net/projects/doublecmd/files/[^"]*doublecmd-[0-9.]*\.qt6\.x86_64\.tar\.xz/download' | \
    head -1 | sed 's/<link>//')
    if [ -z "$LATEST_URL" ]; then
      echo "‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω —Ñ–∞–π–ª .qt6.x86_64.tar.xz –≤ RSS"
      exit 1
    fi
    echo "üì• –°–∫–∞—á–∏–≤–∞–µ–º: $LATEST_URL"
    wget "$LATEST_URL" -O doublecmd.tar.xz

  - tar -xf doublecmd.tar.xz --strip-components=1 -C AppDir/usr/bin

  - |
    if [ -f "AppDir/usr/bin/doublecmd.png" ]; then
      echo "‚û°Ô∏è –ü–µ—Ä–µ–º–µ—â–∞–µ–º –∏–∫–æ–Ω–∫—É –∏–∑ usr/bin"
      mv "AppDir/usr/bin/doublecmd.png" "AppDir/usr/share/icons/hicolor/256x256/apps/"
    elif [ -f "AppDir/usr/share/icons/hicolor/256x256/apps/doublecmd.png" ]; then
      echo "‚úÖ –ò–∫–æ–Ω–∫–∞ —É–∂–µ –Ω–∞ –º–µ—Å—Ç–µ"
    else
      echo "‚ö†Ô∏è –ò–∫–æ–Ω–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
    fi

  - |
    DESKTOP_FILE="AppDir/usr/share/applications/doublecmd.desktop"
    if [ -f "$DESKTOP_FILE" ]; then
      echo "‚úÖ .desktop —Ñ–∞–π–ª —É–∂–µ –Ω–∞ –º–µ—Å—Ç–µ"
    elif [ -f "AppDir/usr/bin/doublecmd.desktop" ]; then
      echo "‚û°Ô∏è –ü–µ—Ä–µ–º–µ—â–∞–µ–º .desktop —Ñ–∞–π–ª –∏–∑ usr/bin"
      mv "AppDir/usr/bin/doublecmd.desktop" "$DESKTOP_FILE"
    else
      echo "‚úçÔ∏è –°–æ–∑–¥–∞–µ–º .desktop —Ñ–∞–π–ª"
      mkdir -p "$(dirname "$DESKTOP_FILE")"
      # –ò—Å–ø–æ–ª—å–∑—É–µ–º printf –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è .desktop —Ñ–∞–π–ª–∞
      printf "[Desktop Entry]\nVersion=1.0\nType=Application\nName=Double Commander\nComment=Cross Platform Open Source file manager\nExec=doublecmd %%F\nIcon=doublecmd\nTerminal=false\nCategories=Utility;FileTools;FileManager;\nMimeType=inode/directory;\nStartupNotify=true\n" > "$DESKTOP_FILE"
    fi

AppDir:
  path: ./AppDir
  app_info:
    id: org.doublecmd.DoubleCommander
    name: DoubleCommander
    icon: doublecmd
    version: latest
    exec: usr/bin/doublecmd
  # –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ: –î–æ–±–∞–≤–ª–µ–Ω –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π –∫–ª—é—á 'include:' –¥–∞–∂–µ —Å –ø—É—Å—Ç—ã–º —Å–ø–∏—Å–∫–æ–º
  apt:
    arch: amd64
    sources:
      - sourceline: deb http://archive.ubuntu.com/ubuntu/ jammy main universe
    include: []
    # –ï—Å–ª–∏ –≤ –±—É–¥—É—â–µ–º –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è –¥–æ–±–∞–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –≤—Ä—É—á–Ω—É—é, —Å–ø–∏—Å–æ–∫ –±—É–¥–µ—Ç —Ç–∞–∫–∏–º:
    # include:
    #   - libgl1
    #   - libx11-6
    #   - –∏ —Ç.–¥.

AppImage:
  arch: x86_64
  sign-key: None
